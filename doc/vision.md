# Техническое видение проекта "ToTheMoon"

Этот документ описывает технические решения, архитектуру и принципы разработки системы скоринга токенов. Он является основой для реализации проекта, описанного в `functional_task.md`.

## 1. Технологии

- **Backend:**
  - **Язык:** Python 3.11+
  - **Фреймворк:** FastAPI. Выбран за высокую производительность, асинхронную природу (необходимую для работы с WebSocket и внешними API) и простоту использования.
  - **База данных:** SQLite. Идеально подходит для нашего принципа "просто, но надежно". Это файловая БД, не требующая отдельного сервера, что упрощает деплой и обслуживание. Для взаимодействия будет использоваться ORM `SQLAlchemy` с `SQLModel` для Pydantic-интеграции.
  - **Работа с API:** `httpx` для асинхронных HTTP-запросов к Birdeye API.
  - **WebSocket:** `websockets` для подключения к `pumpportal.fun`.

- **Frontend:**
  - **Фреймворк:** React 18+ с использованием Vite. Обеспечивает быструю разработку и сборку.
  - **Язык:** TypeScript. Для строгой типизации и повышения надежности кода.
  - **UI:** Mantine UI. Готовая библиотека компонентов для быстрого создания чистого и функционального интерфейса, включая таблицы и графики.
  - **Взаимодействие с API:** `axios` или встроенный `fetch`.

## 2. Принцип разработки

**Простота и надежность.** Мы избегаем оверинжиниринга. Каждое решение должно быть оправданным и минимально достаточным для выполнения задачи. Код должен быть чистым, хорошо документированным (где это необходимо) и покрыт тестами на ключевые бизнес-логики.

## 3. Структура проекта

Проект будет организован как монорепозиторий для упрощения управления.

```
/
├── backend/
│   ├── app/
│   │   ├── api/          # FastAPI эндпоинты
│   │   ├── core/         # Конфигурация, зависимости
│   │   ├── models/       # Модели данных (SQLModel)
│   │   ├── services/     # Бизнес-логика (сбор данных, скоринг)
│   │   └── main.py       # Точка входа в приложение
│   ├── tests/            # Юнит-тесты
│   └── requirements.txt  # Зависимости Python
│
├── frontend/
│   ├── src/
│   │   ├── components/   # React-компоненты
│   │   ├── pages/        # Страницы приложения
│   │   ├── services/     # Логика взаимодействия с API
│   │   └── App.tsx       # Главный компонент
│   └── package.json      # Зависимости Node.js
│
├── scripts/
│   └── deploy.sh         # Скрипт для развертывания
│
├── .env.example          # Пример файла с переменными окружения
├── vision.md
└── functional_task.md
```

## 4. Архитектура проекта

1.  **Сбор данных (Data Ingestion):**
    - Отдельный фоновый процесс (запускаемый вместе с FastAPI) постоянно слушает WebSocket `pumpportal.fun`.
    - При получении нового токена он создает запись в БД со статусом `Initial`.

2.  **Обработка и скоринг (Processing & Scoring):**
    - Периодические фоновые задачи (реализованные через `asyncio.Task`) выполняют следующие действия:
        - **Активация:** Проверяют токены в статусе `Initial`, запрашивают данные из Birdeye API и переводят их в `Active` или `Archived` согласно правилам.
        - **Скоринг:** Для `Active` токенов регулярно рассчитывают скор по формулам из `functional_task.md`.
        - **Обновление статусов:** Проверяют `Active` токены на предмет понижения статуса.

3.  **API (FastAPI):**
    - Предоставляет REST API эндпоинты для фронтенда (`/api/tokens`, `/api/tokens/{id}`).
    - Предоставляет эндпоинты для админ-панели (чтение и запись весов, порогов).
    - Имеет эндпоинт `/health` для проверки работоспособности.

4.  **Frontend (React):**
    - Одностраничное приложение (SPA).
    - Запрашивает данные с бэкенд API и отображает их в виде таблиц и графиков.
    - Позволяет администратору изменять параметры скоринга через специальный интерфейс.

## 5. Модель данных (SQLite)

**Таблица `tokens`:**
- `id` (PK, Integer)
- `token_address` (String, Unique)
- `status` (String: "Initial", "Active", "Archived")
- `created_at` (DateTime)
- `activated_at` (DateTime, Nullable)
- `last_score_value` (Float, Nullable)
- `last_updated` (DateTime)

**Таблица `pools`:**
- `id` (PK, Integer)
- `token_id` (FK -> tokens.id)
- `pool_address` (String, Unique)
- `dex_name` (String)

**Таблица `scoring_parameters`:**
- `id` (PK, Integer)
- `param_name` (String, Unique)
- `param_value` (Float)
- `is_active` (Boolean)

## 6. Сценарии работы

- **Запуск системы:** Оператор запускает `deploy.sh` на сервере. Скрипт поднимает бэкенд и веб-сервер для фронтенда.
- **Работа пользователя:** Пользователь открывает веб-интерфейс, видит список активных токенов, отсортированных по скору, и изучает их динамику.
- **Работа администратора:** Администратор заходит в админ-панель, изменяет весовой коэффициент `W_tx` и сохраняет его. Система скоринга при следующем расчете использует новое значение.

## 7. Деплой

Развертывание будет осуществляться без Docker с помощью скрипта `scripts/deploy.sh` на чистом Linux-сервере.

**Шаги скрипта `deploy.sh`:**
1.  `git pull` для получения последней версии кода.
2.  Установка зависимостей бэкенда: `pip install -r backend/requirements.txt`.
3.  Установка зависимостей фронтенда: `cd frontend && npm install`.
4.  Сборка статических файлов фронтенда: `npm run build`.
5.  Перезапуск бэкенд-сервиса (например, `uvicorn` под управлением `systemd`).
6.  Проверка работоспособности бэкенда через `curl http://localhost:8000/health`. Если ответа нет или он некорректен, скрипт завершается с ошибкой.
7.  Настройка `nginx` (или другого простого веб-сервера) для раздачи статики из `frontend/dist` и проксирования запросов с `/api` на бэкенд (`http://localhost:8000`).

## 8. Подход к конфигурированию

- **Переменные окружения:** Вся конфигурация будет храниться в переменных окружения.
- **Файл `.env`:** В корне проекта будет лежать файл `.env` (добавленный в `.gitignore`), который будет загружаться при старте приложения.
- **Пример (`.env.example`):**
  ```
  # Backend
  DATABASE_URL="sqlite:///./tothemoon.db"
  BIRDEYE_API_KEY="your_api_key"

  # Frontend
  VITE_API_BASE_URL="/api"
  ```

## 9. Подход к логгированию

- **Backend:**
  - Используется стандартный модуль `logging`.
  - Настройка логгера для вывода в `stdout` (для разработки) и в ротируемый файл (`/var/log/tothemoon/app.log`) на сервере.
  - Уровни логирования: `INFO` для ключевых событий (старт, смена статуса токена), `WARNING` для некритичных проблем (не удалось получить данные по одному токену), `ERROR` для серьезных сбоев (отвал БД, недоступность API).

- **Frontend:**
  - В режиме разработки используется `console.log`/`console.error`.
  - Для production-сборки все `console.log` будут удалены. Ошибки будут выводиться в консоль браузера. Внешние системы мониторинга ошибок (Sentry, LogRocket) на данном этапе не используются для сохранения простоты.
